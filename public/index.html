<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dc-manager</title>
  </head>
  <body class="bg-light">
    <a href="#main" class="visually-hidden-focusable">Skip to content</a>

    <div class="container py-4" id="main">
      <section id="login-view" aria-labelledby="login-title">
        <div class="card shadow-sm mx-auto" style="max-width: 640px">
          <div class="card-header text-center bg-primary text-white">
            <h1 class="h3 mb-0" id="login-title">DataCite Unified Console</h1>
          </div>
          <div class="card-body p-4">
            <p class="text-muted text-center">
              Please log in to your DataCite Repository account to enable management features.
            </p>
            <div class="mb-3">
              <label for="api_base" class="form-label">DataCite Environment</label>
              <select id="api_base" class="form-select" aria-describedby="api_base_help">
                <option value="https://api.test.datacite.org" selected>
                  Test Environment
                </option>
                <option value="https://api.datacite.org">Production Environment</option>
              </select>
              <div class="form-text" id="api_base_help">
                Use Test for validation before switching to Production.
              </div>
            </div>
            <div class="mb-3">
              <label for="repositoryId" class="form-label">Repository ID</label>
              <input
                type="text"
                id="repositoryId"
                class="form-control"
                autocomplete="username"
                placeholder="e.g., YOUR.REPO"
              />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                id="password"
                class="form-control"
                autocomplete="current-password"
                placeholder="Your repository password"
              />
              <div class="form-text">
                Passwords are stored only in memory for the current session.
              </div>
            </div>
            <div class="d-grid">
              <button id="loginBtn" class="btn btn-primary btn-lg">
                <span
                  class="spinner-border spinner-border-sm me-2 d-none"
                  role="status"
                  aria-hidden="true"
                  data-spinner
                ></span>
                Login
              </button>
            </div>
            <div id="loginStatus" class="mt-3" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <section id="app-view" class="d-none" aria-live="polite">
        <header class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
          <div id="user-info-header" class="text-muted">Not logged in.</div>
          <button id="logoutBtn" class="btn btn-outline-secondary" type="button">Logout</button>
        </header>

        <ul class="nav nav-tabs" id="main-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="tab-btn-manager"
              data-bs-toggle="tab"
              data-bs-target="#tab-pane-manager"
              type="button"
              role="tab"
            >
              DOI Manager
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="tab-btn-upload"
              data-bs-toggle="tab"
              data-bs-target="#tab-pane-upload"
              type="button"
              role="tab"
            >
              Batch Upload
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="tab-btn-adv-batch"
              data-bs-toggle="tab"
              data-bs-target="#tab-pane-adv-batch"
              type="button"
              role="tab"
            >
              Advanced Batch Update
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <div class="tab-pane fade show active" id="tab-pane-manager" role="tabpanel">
            <div class="card">
              <div class="card-header"><h2 class="h5 mb-0">List and Manage DOIs</h2></div>
              <div class="card-body">
                <div class="row g-3 mb-3">
                  <div class="col-md-5">
                    <label for="filter_prefix_select" class="form-label">Filter by Prefix:</label>
                    <select id="filter_prefix_select" class="form-select"></select>
                  </div>
                  <div class="col-md-5">
                    <label for="filter_query" class="form-label">Filter by Query:</label>
                    <input
                      type="text"
                      class="form-control"
                      id="filter_query"
                      placeholder="e.g., publicationYear:2023 OR climate"
                    />
                  </div>
                  <div class="col-md-2 align-self-end">
                    <button id="btnFetchDois" class="btn btn-success w-100" type="button">
                      Fetch DOIs
                    </button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table id="doisTable" class="table table-striped table-hover" style="width: 100%"></table>
                </div>
                <pre id="fetchStatus" class="mt-2" aria-live="polite"></pre>
                <div
                  id="downloadDisplayedSection"
                  class="mt-3 pt-3 border-top"
                  style="display: none"
                >
                  <h3 class="h6">Download Displayed Results</h3>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label for="list_download_format" class="form-label">Format(s) in ZIP:</label>
                      <select id="list_download_format" class="form-select form-select-sm">
                        <option value="json_attributes" selected>JSON</option>
                        <option value="xml">XML only</option>
                        <option value="both">Both (JSON & XML)</option>
                      </select>
                    </div>
                    <div class="col-md-4 align-self-end">
                      <button id="btnDownloadDisplayedDois" class="btn btn-secondary btn-sm w-100">
                        Download Displayed as ZIP
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="tab-pane-upload" role="tabpanel">
            <div class="card">
              <div class="card-header"><h2 class="h5 mb-0">Batch Upload (JSON & XML)</h2></div>
              <div class="card-body">
                <div class="alert alert-info">
                  <strong>How it works:</strong>
                  <ol class="mb-0">
                    <li>Select one or more <code>.json</code> or <code>.xml</code> metadata files.</li>
                    <li>(Optional) Choose a status (event) to apply to all uploaded DOIs.</li>
                    <li>
                      Click "Start Upload". The tool will automatically create new DOIs or update
                      existing ones.
                    </li>
                  </ol>
                </div>
                <div class="row g-3">
                  <div class="col-md-8">
                    <label for="upload_files_input" class="form-label">1. Select Files</label>
                    <input
                      class="form-control"
                      type="file"
                      id="upload_files_input"
                      multiple
                      accept=".json,.xml"
                    />
                  </div>
                  <div class="col-md-4">
                    <label for="upload_event_select" class="form-label">2. Apply Status (Event)</label>
                    <select id="upload_event_select" class="form-select">
                      <option value="" selected>-- No change --</option>
                      <option value="publish">Publish</option>
                      <option value="register">Register</option>
                      <option value="hide">Hide</option>
                    </select>
                  </div>
                </div>
                <div class="d-grid mt-3">
                  <button id="start_upload_btn" class="btn btn-primary" disabled>Start Upload</button>
                </div>
                <hr class="my-4" />
                <h3 class="h6">Upload Progress</h3>
                <pre id="upload_status_log" aria-live="polite"></pre>
                <div id="upload_results_area" class="mt-4" style="display: none">
                  <h3 class="h6">Results Summary</h3>
                  <div class="table-responsive">
                    <table id="upload_results_table" class="table" width="100%"></table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="tab-pane-adv-batch" role="tabpanel">
            <div class="card">
              <div class="card-header">
                <h2 class="h5 mb-0">Advanced Batch Update with Conditional Logic</h2>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <h3 class="alert-heading h6">How to use this tool</h3>
                  <p>
                    Perform complex, conditional updates on multiple DOIs. Define one or more
                    operations to apply to each DOI matching your filters.
                  </p>
                </div>
                <div class="alert alert-danger">
                  <strong>Warning:</strong> This is a powerful tool. Always perform a
                  <strong>Dry Run</strong> first to verify changes.
                </div>
                <h3 class="h6">1. Filter DOIs to Process</h3>
                <div class="row g-3 mb-3 p-3 border rounded bg-light">
                  <div class="col-md-4">
                    <label for="adv_batch_prefix_select" class="form-label">Filter by Prefix:</label>
                    <select id="adv_batch_prefix_select" class="form-select"></select>
                  </div>
                  <div class="col-md-5">
                    <label for="adv_batch_query" class="form-label">Filter by Query:</label>
                    <input
                      type="text"
                      class="form-control"
                      id="adv_batch_query"
                      placeholder="e.g., publicationYear:2023"
                    />
                  </div>
                  <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check form-switch fs-5">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        role="switch"
                        id="adv_batch_dry_run"
                        checked
                      />
                      <label class="form-check-label" for="adv_batch_dry_run">Dry Run</label>
                    </div>
                  </div>
                </div>
                <h3 class="h6">2. Define Update Operations</h3>
                <div id="adv_batch_operations_container"></div>
                <button id="adv_batch_add_op_btn" class="btn btn-success mt-2" type="button">
                  <i class="bi bi-plus-circle" aria-hidden="true"></i> Add another operation
                </button>
                <hr />
                <h3 class="h6">3. Execute</h3>
                <button id="adv_batch_start_btn" class="btn btn-warning w-100" type="button">
                  Validate and Start Batch Update
                </button>
                <hr />
                <div id="adv_batch_results_area" class="mt-4" style="display: none">
                  <h3 class="h6">Results Summary</h3>
                  <pre id="adv_batch_final_summary"></pre>
                  <h3 class="h6">Affected DOIs</h3>
                  <div class="table-responsive">
                    <table id="adv_batch_results_table" class="table" width="100%"></table>
                  </div>
                </div>
                <pre id="adv_batch_status" class="mt-3" aria-live="polite"></pre>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="operation-block-template" class="d-none">
      <div class="operation-block">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="operation-title h6 mb-0">Operation X</h4>
          <button type="button" class="btn-close remove-op-btn" aria-label="Remove operation"></button>
        </div>
        <hr class="my-2" />
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label small">Attribute to Modify</label>
            <input
              type="text"
              class="form-control form-control-sm"
              name="attribute"
              placeholder="e.g., publisher or titles[].title"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label small">Regex Pattern (optional)</label>
            <input type="text" class="form-control form-control-sm" name="pattern" placeholder="e.g., Old Text" />
          </div>
          <div class="col-md-6">
            <label class="form-label small">Replacement Value</label>
            <textarea
              class="form-control form-control-sm"
              name="replacement"
              rows="1"
              placeholder="e.g., New Text or JSON {}"
            ></textarea>
          </div>
        </div>
        <div class="mt-2">
          <button type="button" class="btn btn-sm btn-outline-secondary toggle-condition-btn">
            Add Condition
          </button>
        </div>
        <div class="condition-fields mt-2 p-2 border bg-white" style="display: none">
          <label class="form-label small text-muted">Condition: Update only if this is met.</label>
          <div class="row g-2">
            <div class="col-12">
              <label class="form-label small">Condition Attribute</label>
              <input
                type="text"
                class="form-control form-control-sm"
                name="condition_attribute"
                placeholder="e.g., types.resourceTypeGeneral"
              />
            </div>
            <div class="col-12">
              <label class="form-label small">Condition Pattern (Regex)</label>
              <input type="text" class="form-control form-control-sm" name="condition_pattern" />
            </div>
          </div>
          <div class="form-text small">
            <strong>Tip:</strong> If Replacement Value is empty, the value matched by this pattern will be
            used as the replacement.
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="editorModal"
      tabindex="-1"
      aria-labelledby="editorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editorModalLabel">Edit Metadata</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea id="editor-modal-content" class="form-control" rows="20"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" id="editorCopyBtn">Copy</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="editorUpdateBtn">Update</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="statusModal"
      tabindex="-1"
      aria-labelledby="statusModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="statusModalLabel">Change DOI Status</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Select new event for DOI: <strong id="statusModalDoi"></strong></p>
            <select id="statusModalSelect" class="form-select"></select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="statusModalUpdateBtn">Apply Event</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="deleteModal"
      tabindex="-1"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this draft DOI? This action cannot be undone.</p>
            <p><strong>DOI:</strong> <span id="deleteModalDoi"></span></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="deleteModalConfirmBtn">
              Yes, Delete this DOI
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="downloadConfirmModal"
      tabindex="-1"
      aria-labelledby="downloadConfirmLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="downloadConfirmLabel">Confirm Download</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>This will download <strong id="downloadConfirmCount">N/A</strong> DOIs. Proceed?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="proceedDownloadBtn">Proceed</button>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
